<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<title>src/Tactic/Core/Syntax.hs</title>
</head>
<head>
<link type='text/css' rel='stylesheet' href='liquid.css' />
</head>

<body>
<hr>
Put mouse over identifiers to see inferred types
<pre><span class=hs-linenum>  1: </span><span class='hs-comment'>{-# LANGUAGE NamedFieldPuns #-}</span>
<span class=hs-linenum>  2: </span><span class='hs-comment'>{-# LANGUAGE PackageImports #-}</span>
<span class=hs-linenum>  3: </span><span class='hs-comment'>{-# LANGUAGE QuasiQuotes #-}</span>
<span class=hs-linenum>  4: </span><span class='hs-comment'>{-# LANGUAGE TemplateHaskell #-}</span>
<span class=hs-linenum>  5: </span>
<span class=hs-linenum>  6: </span><span class='hs-keyword'>{-@</span> <span class='hs-conid'>LIQUID</span> <span class='hs-str'>"--compile-spec"</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>  7: </span><span class='hs-keyword'>{-@</span> <span class='hs-conid'>LIQUID</span> <span class='hs-str'>"--no-positivity"</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>  8: </span>
<span class=hs-linenum>  9: </span><span class='hs-keyword'>module</span> <span class='hs-conid'>Tactic.Core.Syntax</span> <span class='hs-keyword'>where</span>
<span class=hs-linenum> 10: </span>
<span class=hs-linenum> 11: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Char</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Char</span>
<span class=hs-linenum> 12: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-keyword'>qualified</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>List</span>
<span class=hs-linenum> 13: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<span class=hs-linenum> 14: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Language.Haskell.TH</span>
<span class=hs-linenum> 15: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Language.Haskell.TH.Datatype</span>
<span class=hs-linenum> 16: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Language.Haskell.TH.Ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprint</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 17: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Language.Haskell.TH.Quote</span>
<span class=hs-linenum> 18: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Language.Haskell.TH.Syntax</span>
<span class=hs-linenum> 19: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO.Unsafe</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafePerformIO</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 20: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Tactic.Core.Debug</span>
<span class=hs-linenum> 21: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 22: </span>
<span class=hs-linenum> 23: </span><span class='hs-keyword'>data</span> <span class='hs-conid'>Instr</span>
<span class=hs-linenum> 24: </span>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- | splices a lambda; adds name to environment</span>
<span class=hs-linenum> 25: </span>    <span class='hs-conid'>Intro</span> <span class='hs-layout'>{</span><span class='hs-varid'>name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span><span class='hs-layout'>}</span>
<span class=hs-linenum> 26: </span>  <span class='hs-keyglyph'>|</span> <span class='hs-comment'>-- | destructs a datatype</span>
<span class=hs-linenum> 27: </span>    <span class='hs-conid'>Destruct</span> <span class='hs-layout'>{</span><span class='hs-varid'>name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-varid'>intros</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>flags</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>}</span>
<span class=hs-linenum> 28: </span>  <span class='hs-keyglyph'>|</span> <span class='hs-comment'>-- | inducts on an input argument</span>
<span class=hs-linenum> 29: </span>    <span class='hs-conid'>Induct</span> <span class='hs-layout'>{</span><span class='hs-varid'>name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-varid'>intros</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>flags</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>}</span>
<span class=hs-linenum> 30: </span>  <span class='hs-keyglyph'>|</span> <span class='hs-comment'>-- | add hint to subsequent auto hints</span>
<span class=hs-linenum> 31: </span>    <span class='hs-conid'>Hint</span> <span class='hs-layout'>{</span><span class='hs-varid'>exp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exp</span><span class='hs-layout'>}</span>
<span class=hs-linenum> 32: </span>  <span class='hs-keyglyph'>|</span> <span class='hs-comment'>-- | auto</span>
<span class=hs-linenum> 33: </span>    <span class='hs-conid'>Auto</span> <span class='hs-layout'>{</span><span class='hs-varid'>hints</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Exp</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>depth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-layout'>}</span>
<span class=hs-linenum> 34: </span>  <span class='hs-keyglyph'>|</span> <span class='hs-comment'>-- | asserts the case where a boolean exp holds</span>
<span class=hs-linenum> 35: </span>    <span class='hs-conid'>Assert</span> <span class='hs-layout'>{</span><span class='hs-varid'>exp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exp</span><span class='hs-layout'>,</span> <span class='hs-varid'>requires</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>}</span>
<span class=hs-linenum> 36: </span>  <span class='hs-keyglyph'>|</span> <span class='hs-comment'>-- | dismisses the case where  a boolean exp holds</span>
<span class=hs-linenum> 37: </span>    <span class='hs-conid'>Dismiss</span> <span class='hs-layout'>{</span><span class='hs-varid'>exp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exp</span><span class='hs-layout'>,</span> <span class='hs-varid'>requires</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>}</span>
<span class=hs-linenum> 38: </span>  <span class='hs-keyglyph'>|</span> <span class='hs-comment'>-- | use refinment of an exp</span>
<span class=hs-linenum> 39: </span>    <span class='hs-conid'>Use</span> <span class='hs-layout'>{</span><span class='hs-varid'>exp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exp</span><span class='hs-layout'>,</span> <span class='hs-varid'>requires</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>}</span>
<span class=hs-linenum> 40: </span>  <span class='hs-keyglyph'>|</span> <span class='hs-comment'>-- | condition on a boolean exp</span>
<span class=hs-linenum> 41: </span>    <span class='hs-conid'>Cond</span> <span class='hs-layout'>{</span><span class='hs-varid'>exp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exp</span><span class='hs-layout'>,</span> <span class='hs-varid'>requires</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>}</span>
<span class=hs-linenum> 42: </span>  <span class='hs-keyglyph'>|</span> <span class='hs-comment'>-- | refine an application, automatically looking for completions</span>
<span class=hs-linenum> 43: </span>    <span class='hs-conid'>Refine</span> <span class='hs-layout'>{</span><span class='hs-varid'>string</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-varid'>requires</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>}</span>
<span class=hs-linenum> 44: </span>  <span class='hs-keyglyph'>|</span> <span class='hs-comment'>-- | trivial</span>
<span class=hs-linenum> 45: </span>    <span class='hs-conid'>Trivial</span>
<span class=hs-linenum> 46: </span>
<span class=hs-linenum> 47: </span><span class='hs-definition'>defaultAutoHints</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Exp</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum> 48: </span>
<span class=hs-linenum> 49: </span><span class='hs-definition'>defaultAutoDepth</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>3</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<span class=hs-linenum> 50: </span>
<span class=hs-linenum> 51: </span><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-conid'>Instr</span> <span class='hs-keyword'>where</span>
<span class=hs-linenum> 52: </span>  <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Intro</span> <span class='hs-layout'>{</span><span class='hs-varid'>name</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"intro "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>name</span>
<span class=hs-linenum> 53: </span>  <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Destruct</span> <span class='hs-layout'>{</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>intros</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"destruct "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>name</span> <span class='hs-varop'>++</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>intros</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>intros</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>" as "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showIntros</span> <span class='hs-varid'>intros</span><span class='hs-layout'>;</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>""</span>
<span class=hs-linenum> 54: </span>  <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Induct</span> <span class='hs-layout'>{</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>intros</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"induct "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>name</span> <span class='hs-varop'>++</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>intros</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>intros</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>" as "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showIntros</span> <span class='hs-varid'>intros</span><span class='hs-layout'>;</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>""</span>
<span class=hs-linenum> 55: </span>  <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Hint</span> <span class='hs-layout'>{</span><span class='hs-varid'>exp</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"hint "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>pprint</span> <span class='hs-varid'>exp</span>
<span class=hs-linenum> 56: </span>  <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Auto</span> <span class='hs-layout'>{</span><span class='hs-varid'>hints</span><span class='hs-layout'>,</span> <span class='hs-varid'>depth</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"auto "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprint</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>hints</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>" "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>depth</span>
<span class=hs-linenum> 57: </span>  <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Assert</span> <span class='hs-layout'>{</span><span class='hs-varid'>exp</span><span class='hs-layout'>,</span> <span class='hs-varid'>requires</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"assert "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>pprint</span> <span class='hs-varid'>exp</span> <span class='hs-varop'>++</span> <span class='hs-str'>" requires "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>requires</span>
<span class=hs-linenum> 58: </span>  <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dismiss</span> <span class='hs-layout'>{</span><span class='hs-varid'>exp</span><span class='hs-layout'>,</span> <span class='hs-varid'>requires</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"dismiss "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>pprint</span> <span class='hs-varid'>exp</span> <span class='hs-varop'>++</span> <span class='hs-str'>" requires "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>requires</span>
<span class=hs-linenum> 59: </span>  <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-layout'>{</span><span class='hs-varid'>exp</span><span class='hs-layout'>,</span> <span class='hs-varid'>requires</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"use "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>pprint</span> <span class='hs-varid'>exp</span> <span class='hs-varop'>++</span> <span class='hs-str'>" requires "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>requires</span>
<span class=hs-linenum> 60: </span>  <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cond</span> <span class='hs-layout'>{</span><span class='hs-varid'>exp</span><span class='hs-layout'>,</span> <span class='hs-varid'>requires</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"cond "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>pprint</span> <span class='hs-varid'>exp</span> <span class='hs-varop'>++</span> <span class='hs-str'>" requires "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>requires</span>
<span class=hs-linenum> 61: </span>  <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refine</span> <span class='hs-layout'>{</span><span class='hs-varid'>string</span><span class='hs-layout'>,</span> <span class='hs-varid'>requires</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"refine {"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>string</span> <span class='hs-varop'>++</span> <span class='hs-str'>"} requires "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>requires</span>
<span class=hs-linenum> 62: </span>  <span class='hs-varid'>show</span> <span class='hs-conid'>Trivial</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"trivial"</span>
<span class=hs-linenum> 63: </span>
<span class=hs-linenum> 64: </span><span class='hs-definition'>showIntros</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<span class=hs-linenum> 65: </span><span class='hs-definition'>showIntros</span> <span class='hs-varid'>intros</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"["</span> <span class='hs-varop'>++</span> <span class='hs-conid'>List.intercalate</span> <span class='hs-str'>" | "</span> <span class='hs-layout'>(</span><span class='hs-conid'>List.intercalate</span> <span class='hs-str'>" "</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>intros</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>"]"</span>
<span class=hs-linenum> 66: </span>
<span class=hs-linenum> 67: </span><span class='hs-keyword'>type</span> <span class='hs-conid'>Ctx</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Exp</span> <span class='hs-conid'>Type</span>
<span class=hs-linenum> 68: </span>
<span class=hs-linenum> 69: </span><span class='hs-keyword'>data</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Environment</span>
<span class=hs-linenum> 70: </span>  <span class='hs-layout'>{</span> <span class='hs-varid'>def_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 71: </span>    <span class='hs-varid'>def_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 72: </span>    <span class='hs-varid'>def_argTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 73: </span>    <span class='hs-varid'>def_argNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 74: </span>    <span class='hs-varid'>arg_i</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 75: </span>    <span class='hs-varid'>args_rec_ctx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Int</span> <span class='hs-conid'>Ctx</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- recursive-allowed context for each arg</span>
<span class=hs-linenum> 76: </span>    <span class='hs-varid'>ctx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ctx</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 77: </span>    <span class='hs-varid'>var_i</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<span class=hs-linenum> 78: </span>  <span class='hs-layout'>}</span>
<span class=hs-linenum> 79: </span>
<span class=hs-linenum> 80: </span><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-conid'>Environment</span> <span class='hs-keyword'>where</span>
<span class=hs-linenum> 81: </span>  <span class='hs-varid'>show</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span>
<span class=hs-linenum> 82: </span>    <span class='hs-varid'>unlines</span>
<span class=hs-linenum> 83: </span>      <span class='hs-keyglyph'>[</span> <span class='hs-str'>"def_name: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>def_name</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 84: </span>        <span class='hs-str'>"def_type: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>def_type</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 85: </span>        <span class='hs-str'>"def_argTypes: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>def_argTypes</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 86: </span>        <span class='hs-str'>"def_argNames: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>def_argNames</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 87: </span>        <span class='hs-str'>"arg_i: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_i</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 88: </span>        <span class='hs-str'>"args_rec_ctx: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>args_rec_ctx</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 89: </span>        <span class='hs-str'>"ctx: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctx</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 90: </span>      <span class='hs-keyglyph'>]</span>
<span class=hs-linenum> 91: </span>
<span class=hs-linenum> 92: </span><span class='hs-definition'>introArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span>
<span class=hs-linenum> 93: </span><span class='hs-definition'>introArg</span> <span class='hs-varid'>name</span> <span class='hs-varid'>type_</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span>
<span class=hs-linenum> 94: </span>  <span class='hs-varid'>env</span>
<span class=hs-linenum> 95: </span>    <span class='hs-layout'>{</span> <span class='hs-comment'>-- these are handled during parsing</span>
<span class=hs-linenum> 96: </span>      <span class='hs-comment'>-- def_argNames = def_argNames env ++ [name],</span>
<span class=hs-linenum> 97: </span>      <span class='hs-comment'>-- def_argTypes = def_argTypes env ++ [type_],</span>
<span class=hs-linenum> 98: </span>      <span class='hs-varid'>arg_i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_i</span> <span class='hs-varid'>env</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 99: </span>      <span class='hs-varid'>ctx</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map.insert</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarE</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>type_</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ctx</span> <span class='hs-varid'>env</span>
<span class=hs-linenum>100: </span>    <span class='hs-layout'>}</span>
<span class=hs-linenum>101: </span>
<span class=hs-linenum>102: </span><span class='hs-definition'>insertCtx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span>
<span class=hs-linenum>103: </span><span class='hs-definition'>insertCtx</span> <span class='hs-varid'>e</span> <span class='hs-varid'>type_</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span>
<span class=hs-linenum>104: </span>  <span class='hs-varid'>env</span>
<span class=hs-linenum>105: </span>    <span class='hs-layout'>{</span> <span class='hs-varid'>ctx</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map.insert</span> <span class='hs-varid'>e</span> <span class='hs-varid'>type_</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ctx</span> <span class='hs-varid'>env</span>
<span class=hs-linenum>106: </span>    <span class='hs-layout'>}</span>
<span class=hs-linenum>107: </span>
<span class=hs-linenum>108: </span><span class='hs-definition'>deleteCtx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span>
<span class=hs-linenum>109: </span><span class='hs-definition'>deleteCtx</span> <span class='hs-varid'>e</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span>
<span class=hs-linenum>110: </span>  <span class='hs-varid'>env</span>
<span class=hs-linenum>111: </span>    <span class='hs-layout'>{</span> <span class='hs-varid'>ctx</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map.delete</span> <span class='hs-varid'>e</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ctx</span> <span class='hs-varid'>env</span>
<span class=hs-linenum>112: </span>    <span class='hs-layout'>}</span>
<span class=hs-linenum>113: </span>
<span class=hs-linenum>114: </span><span class='hs-definition'>emptyEnvironment</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Environment</span>
<span class=hs-linenum>115: </span><span class='hs-definition'>emptyEnvironment</span> <span class='hs-keyglyph'>=</span>
<span class=hs-linenum>116: </span>  <span class='hs-conid'>Environment</span>
<span class=hs-linenum>117: </span>    <span class='hs-layout'>{</span> <span class='hs-varid'>def_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>undefined</span><span class='hs-layout'>,</span>
<span class=hs-linenum>118: </span>      <span class='hs-varid'>def_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>undefined</span><span class='hs-layout'>,</span>
<span class=hs-linenum>119: </span>      <span class='hs-varid'>def_argTypes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<span class=hs-linenum>120: </span>      <span class='hs-varid'>def_argNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<span class=hs-linenum>121: </span>      <span class='hs-varid'>arg_i</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span>
<span class=hs-linenum>122: </span>      <span class='hs-varid'>args_rec_ctx</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map.empty</span><span class='hs-layout'>,</span>
<span class=hs-linenum>123: </span>      <span class='hs-varid'>ctx</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map.empty</span><span class='hs-layout'>,</span>
<span class=hs-linenum>124: </span>      <span class='hs-varid'>var_i</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<span class=hs-linenum>125: </span>    <span class='hs-layout'>}</span>
<span class=hs-linenum>126: </span>
<span class=hs-linenum>127: </span><span class='hs-definition'>inferType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Q</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<span class=hs-linenum>128: </span><span class='hs-definition'>inferType</span> <span class='hs-varid'>e</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum>129: </span>  <span class='hs-keyword'>case</span> <span class='hs-conid'>Map.lookup</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctx</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<span class=hs-linenum>130: </span>    <span class='hs-conid'>Just</span> <span class='hs-varid'>type_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>type_</span>
<span class=hs-linenum>131: </span>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<span class=hs-linenum>132: </span>      <span class='hs-conid'>VarE</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum>133: </span>        <span class='hs-comment'>-- just to check if the name is in scope</span>
<span class=hs-linenum>134: </span>        <span class='hs-varid'>mb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupValueName</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameBase</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<span class=hs-linenum>135: </span>        <span class='hs-keyword'>case</span> <span class='hs-varid'>mb</span> <span class='hs-keyword'>of</span>
<span class=hs-linenum>136: </span>          <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum>137: </span>            <span class='hs-varid'>debugM</span> <span class='hs-varop'>$!</span> <span class='hs-str'>"inferType of "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>e</span>
<span class=hs-linenum>138: </span>            <span class='hs-conid'>Just</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>name</span>
<span class=hs-linenum>139: </span>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>140: </span>            <span class='hs-varid'>pure</span> <span class='hs-conid'>Nothing</span>
<span class=hs-linenum>141: </span>      <span class='hs-conid'>ConE</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>name</span>
<span class=hs-linenum>142: </span>
<span class=hs-linenum>143: </span><span class='hs-definition'>nameToExp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Exp</span>
<span class=hs-linenum>144: </span><span class='hs-definition'>nameToExp</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span>
<span class=hs-linenum>145: </span>  <span class='hs-keyword'>case</span> <span class='hs-varid'>nameBase</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<span class=hs-linenum>146: </span>    <span class='hs-layout'>(</span><span class='hs-varid'>c</span> <span class='hs-conop'>:</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>147: </span>      <span class='hs-keyword'>if</span> <span class='hs-conid'>Char.isLower</span> <span class='hs-varid'>c</span>
<span class=hs-linenum>148: </span>        <span class='hs-keyword'>then</span> <span class='hs-conid'>VarE</span> <span class='hs-varid'>name</span>
<span class=hs-linenum>149: </span>        <span class='hs-keyword'>else</span> <span class='hs-conid'>ConE</span> <span class='hs-varid'>name</span>
</pre>
</body>
</html>